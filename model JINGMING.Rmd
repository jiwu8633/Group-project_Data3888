---
title: "Untitled"
output: html_document
date: "2025-04-14"
---

import the package
```{r}
library(GEOquery)
library(stringr)
library(ggplot2)
library(limma)
library(tidyverse)
library(caret)
library(randomForest)
```


set the seed
```{r}
set.seed(3888)
```


import the data
```{r}
gse <- getGEO("GSE48060")

gse <- gse$GSE48060_series_matrix.txt.gz


expr_data = exprs(gse)
pheno = pData(gse)
feature = fData(gse)
```


divide the data in two group
```{r}
y <- ifelse(grepl("normal control", gse$title), "Control", "Stable")
pheno$group <- y

design <- model.matrix(~0 + pheno$group)
colnames(design) <- c("Control",  "Stable")
fit <- lmFit(expr_data, design)
contrast.matrix <- makeContrasts(Control-Stable, levels=design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
degs <- topTable(fit2, adjust="fdr", number=Inf)
degs
```


select the top 20 significant genes
Cross Fold and use with the example with the random forest
```{r}
top_genes <- head(rownames(degs[order(abs(degs$logFC), decreasing = TRUE), ]), 20)


train_data <- t(expr_data[top_genes, ])
train_data <- as.data.frame(train_data)
colnames(train_data) <- make.names(colnames(train_data))


colnames(train_data)[ncol(train_data)] <- "Group"
train_data$Group <- as.factor(pheno$group)

k <- 5
folds <- createFolds(train_data$Group, k = k, list = TRUE, returnTrain = TRUE)


predictions <- list()
actual <- list()
importance <- list()
prob_predictions <- list()



for(i in 1:k) {
  train_idx <- folds[[i]]
  train_set <- train_data[train_idx, ]
  test_set <- train_data[-train_idx, ]
  

  rf_model <- randomForest(Group ~ ., 
                           data = train_set,
                           ntree = 100,
                           importance = TRUE)
  
  predictors <- setdiff(colnames(train_set), "Group")
  pred <- predict(rf_model, test_set[, predictors])
  pred_prob <- predict(rf_model, test_set[, predictors], type = "prob")
  
  predictions[[i]] <- pred
  actual[[i]] <- test_set$Group
  prob_predictions[[i]] <- pred_prob
  importance[[i]] <- importance(rf_model)
}


all_pred <- unlist(predictions)
all_actual <- unlist(actual)


conf_matrix <- confusionMatrix(all_pred, all_actual)


print("confusion matrix")
print(conf_matrix)

# show the predicted and the real value
predicted_probs <- prob_predictions[[1]]
true_labels <- train_data$Group[-folds[[1]]]

result <- data.frame(
  Predicted = predicted_probs,
  RealLabel = true_labels
)

print(result)

# calculate which genes have the bigger affect
mean_importance <- do.call(rbind, importance)
mean_importance <- apply(mean_importance, 2, mean)
print("feature importance:")
print(sort(mean_importance, decreasing = TRUE))


varImpPlot(rf_model)
```




